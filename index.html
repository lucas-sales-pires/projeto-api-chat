<!DOCTYPE html>
<html>
<head>
    <title>Chat com Socket.IO</title>
    <style>
        body { font-family: sans-serif; }
        #chat, #login { width: 400px; margin: 0 auto; }
        #mensagens { height: 300px; overflow-y: scroll; border: 1px solid #ccc; padding: 10px; }
        #usuarios { padding: 10px; }
    </style>
</head>
<body>
    <div id="login">
        <input type="text" id="username" placeholder="Nome de usuário">
        <button id="loginButton">Entrar</button>
    </div>
    

    <div id="chat" style="display:none">
        <div id="sala">
            <input type="text" id="nomeSala" placeholder="Nome da sala">
            <button id="entrarSalaButton">Entrar na Sala</button>
        </div>
        <div id="usuarios"></div>
        <div id="mensagens"></div>
        <input type="text" id="mensagemInput" placeholder="Digite sua mensagem">
        <button id="enviarButton">Enviar</button>
    </div>

    <script src="https://cdn.socket.io/4.4.1/socket.io.min.js"></script>
    <script>
        const socket = io('http://localhost:8010'); 
        let salaAtual = null;
        let usuario = null; 

        document.getElementById('loginButton').addEventListener('click', async () => {
            const username = document.getElementById('username').value;

            try {
                const response = await fetch(`http://localhost:8010/api/usuarios/login`, { 
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json'
                  },
                    body: JSON.stringify({ username })
              });

              if (!response.ok) {
                  throw new Error('Usuário não encontrado');
              }
              usuario = await response.json();
                document.getElementById('login').style.display = 'none';
                document.getElementById('chat').style.display = 'block';
            } catch (error) {
                alert(error.message);
            }
        });

        document.getElementById('entrarSalaButton').addEventListener('click', () => {
            const nomeSala = document.getElementById('nomeSala').value;
            socket.emit('entrarNaSala', nomeSala);
            salaAtual = nomeSala;
        });

        socket.on('atualizarUsuarios', (usuarios) => {
            const usuariosDiv = document.getElementById('usuarios');
            usuariosDiv.innerHTML = '<h2>Usuários:</h2><ul>' + usuarios.map(u => `<li>${u}</li>`).join('') + '</ul>';
        });

        document.getElementById('enviarButton').addEventListener('click', () => {
            const mensagemInput = document.getElementById('mensagemInput');
            socket.emit('novaMensagem', { sala: salaAtual, mensagem: mensagemInput.value });
            mensagemInput.value = '';
        });

        socket.on('mensagemRecebida', (dados) => {
            const mensagensDiv = document.getElementById('mensagens');
            mensagensDiv.innerHTML += `<p><strong>${dados.username}:</strong> ${dados.texto}</p>`;
            mensagensDiv.scrollTop = mensagensDiv.scrollHeight; 
        });

        socket.on('historicoMensagens', (mensagens) => {
            const mensagensDiv = document.getElementById('mensagens');
            mensagensDiv.innerHTML = mensagens.map(msg => `<p><strong>${msg.username}:</strong> ${msg.texto} (${new Date(msg.timestamp).toLocaleString()})</p>`).join('');
            mensagensDiv.scrollTop = mensagensDiv.scrollHeight; 
        });
    </script>
</body>
</html>
